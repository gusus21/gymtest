<!doctype html>
<html>
<head>
	<title> Gay website </title>
	<link rel="stylesheet" href="styles.css">
</head>
<body onload="buttonVisible(), loopedBackground(), module.getMixes()">
	<header>
		<div class="navbar">
			<div class="nav-content button">
				<span>Info</span>
			</div>
			<div class="nav-content button" onclick="showMusic()">
				<span>Gachi mixes</span>
			</div>
			<div class="collapsed-button button" onclick="collapsedMenuShow()">
				<span>Menu</span>
			</div>
		</div>
		
		<div id="collapse">
			<ul>
				<li class="nav-min"><div class="collapsed-content button" onclick="showMusic()">Gachi mixes</div></li>
				<li class="nav-min"><div class="collapsed-content button">Info</div></li>
			</ul>
		</div>
	</header>
	<h1>
		<i>Gym 224 One Love</i>
	</h1>

		<div class = "image" id="image" style = "font-size: 30px; text-align: center; display: flex; justify-content: center;
		 align-items: center; visibility: hidden; flex-wrap: wrap; flex-direction: row;">
			<img src = "https://cutt.ly/mKy80ID">
			Welcome to the Gym 224
			<img src = "https://cutt.ly/XKy4TBB">
		</div>
		<div id = "kostyl"></div>
	<div id="musicList" style="visibility:hidden;" onclick="playAudio()">
		<article style="font-size: 20px">Some Gachi mixes:</article>
		<ul id="musicListInternal"></ul>
		<audio id="audio" src="../audio/fisting-is-300-.mp3" muted autoplay></audio>
		<audio id="music" src="../audio/boss-in-this-gy.mp3" muted autoplay></audio>
		<div id="add-button" class="button" onclick="module.addMix()">
			<span>Add</span>
		</div>
	</div> 
	<script src="script.js"></script>
	<script>let module = {};</script>
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-app.js";
		import { getDatabase, ref, child, get, set, update, remove, push } from "https://www.gstatic.com/firebasejs/9.8.4/firebase-database.js";

		const firebaseConfig = {
			apiKey: "AIzaSyCtiljiSdfz0fm0hRBRwyExgIk2SzsZ--s",
			authDomain: "gym224website.firebaseapp.com",
			projectId: "gym224website",
			storageBucket: "gym224website.appspot.com",
			messagingSenderId: "521799187351",
			appId: "1:521799187351:web:9d68ae622efca7b977a2d2",
			databaseURL: "https://gym224website-default-rtdb.europe-west1.firebasedatabase.app"
		};
		const app = initializeApp(firebaseConfig);

		module.getMixes = () => {
			let dbRef = ref(getDatabase());
			get(child(dbRef, "mixes")).then((snapshot) => {
				if (snapshot.exists())
				{
					snapshot.forEach((childSnapshot) => {
						addLink(childSnapshot.key, childSnapshot.val());
					});
				}
				else
				{
					console.log("No data available");
				}
				}).catch((error) => {
				console.error(error);
			});
		}

		module.addMix = () => {
			let link = prompt("Enter link...");
			if (link == "")//TODO: add regex for link
			{
				alert("No link was given!");
			}
			else if (link != null)
			{
				let name = prompt("Enter track name...");
				if (name == "")
				{
					alert("No name was given!");
				}
				else if (name != null)
				{
					let linkNName = link + "," + name;
					let mixCount = document.getElementById("musicListInternal").childElementCount;
					let mixId = push(child(ref(getDatabase()), 'mixes')).key;
					set(ref(getDatabase(app), 'mixes/' + mixId), linkNName);
					addLink(mixId, linkNName);
				}
			}
		};

		function addLink(idFromDB, dataFromDB)
		{
			//parse
			let linkNName = dataFromDB.split(',');
			let link = linkNName[0];
			let name = linkNName[1];
			if (linkNName.length > 2)
			{
				for (let i = 2; i < linkNName.length; i++)
				{
					name += "," + linkNName[i];
				}
			}
			//<a> element
			let linkItem = document.createElement('a');
			linkItem.target = "_blank";
			linkItem.href = link;
			linkItem.textContent = name;
			//<a> element for edit
			let linkItemEdit = document.createElement('a');
			linkItemEdit.textContent = " ‚úèÔ∏è";
			linkItemEdit.setAttribute("onclick", "module.editMix(this, \"" + idFromDB + "\")");
			//<a> element for delete
			let linkItemDelete = document.createElement('a');
			linkItemDelete.textContent = " üóëÔ∏è";
			linkItemDelete.setAttribute("onclick", "module.deleteMix(this, \"" + idFromDB + "\")");
			//<li> element
			let listItem = document.createElement('li');
			listItem.className = "link";
			listItem.appendChild(linkItem);
			listItem.appendChild(linkItemEdit);
			listItem.appendChild(linkItemDelete);
			//adding
			document.getElementById("musicListInternal").appendChild(listItem);
		}

		module.editMix = (clickedEl, mixId) => {
			let newLink = null, newName = null;
			if (confirm("Do you want to edit track link?"))
			{
				newLink = prompt("Enter new link...");
				if (newLink == "")//TODO: add regex for link (it is copy)
				{
					alert("No link was given!");
					newLink = null;
				}
			}
			if (confirm("Do you want to edit track name?"))
			{
				newName = prompt("Enter new name...");
				if (newName == "")//TODO: add regex for link (it is copy)
				{
					alert("No name was given!");
					newName = null;
				}
			}
			if (newName != null || newLink != null)//if there is any data to edit
			{
				let element = clickedEl.parentNode.childNodes.item(0);
				if (newLink == null) newLink = element.href;
				else element.href = newLink;
				if (newName == null) newName = element.textContent;
				else element.textContent = newName;
				let updates = {};
				updates["/mixes/" + mixId] = newLink + "," + newName;
				update(ref(getDatabase()), updates);
			}
		};

		module.deleteMix = (clickedEl, mixId) => {
			let liToDel = clickedEl.parentNode;
			let dbRef = ref(getDatabase());
			remove(child(dbRef, "/mixes/" + mixId));
			liToDel.remove();
		};
	</script>
</body>
</html>	